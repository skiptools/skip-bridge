
skip:
  #mode: 'swift'
  mode: 'kotlin'

build:
  contents:
    - block: 'tasks.withType<org.gradle.api.tasks.compile.AbstractCompile>'
      contents:
        - 'dependsOn("buildSwiftPackage")'

    - block: 'tasks.register("buildSwiftPackage")'
      contents:
        - block: 'doLast'
          contents:
            - 'System.getenv().toSortedMap().forEach { key, value -> println("${key}=\"${value}\"") }'
            - block: 'exec'
              contents:
                - 'environment("SKIP_PLUGIN_DISABLED", "1")'
                # Invoke the native swift-android toolchain, which will create .so libraries for each specified architecture
                - 'commandLine("sh", "-c", "swift build --package-path src/main/swift && skip android build -d .build/jni-libs --package-path src/main/swift")'

    - block: 'android'
      contents:
        - block: 'sourceSets'
          contents:
            # .build/jni-libs/ is the folder where our toolchain outputs the natively-compiled .so files
            - 'getByName("main").jniLibs.srcDirs(".build/jni-libs")'
        - block: 'packaging'
          contents:
            # keepDebugSymbols is needed to prevent errors like: java.lang.UnsatisfiedLinkError: dlopen failed: empty/missing DT_HASH/DT_GNU_HASH in "/data/app/~~Zoepnr93K9vyUtTUUM0POg==/skip.bridge.samples.test-3nePwd6ioGZtLQ0K0EJpBQ==/base.apk!/lib/arm64-v8a/libdispatch.so" (new hash type from the future?)
            - 'jniLibs.keepDebugSymbols.add("**/*.so")'

